generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                    String                 @id @default(cuid())
  email                 String                 @unique
  password              String?
  name                  String?
  role                  UserRole               @default(STUDENT)
  avatar                String?
  phone                 String?
  address               String?
  dateOfBirth           DateTime?
  isActive              Boolean                @default(true)
  lastLogin             DateTime?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  attendancesMarked     Attendance[]           @relation("AttendanceMarker")
  auditLogs             AuditLog[]
  BehaviorRecord        BehaviorRecord[]
  inventoryTransactions InventoryTransaction[] @relation("InventoryTransactionPerformer")
  receivedMessages      Message[]              @relation("MessageReceiver")
  sentMessages          Message[]              @relation("MessageSender")
  notifications         Notification[]
  parent                Parent?
  staffProfile          Staff?
  studentProfile        Student?
  teacherProfile        Teacher?

  @@index([email])
  @@index([role])
}

model Student {
  id                   String                @id @default(cuid())
  userId               String                @unique
  rollNumber           String                @unique
  admissionNumber      String                @unique
  admissionDate        DateTime              @default(now())
  firstName            String
  lastName             String
  gender               String
  dateOfBirth          DateTime
  bloodGroup           String?
  religion             String?
  nationality          String                @default("Local")
  motherTongue         String?
  phone                String
  email                String?
  emergencyContact     String
  emergencyPhone       String
  address              String
  city                 String
  state                String
  zipCode              String
  gradeId              String
  sectionId            String
  academicYearId       String
  house                String?
  guardianId           String
  relationship         String
  allergies            String?
  medicalConditions    String?
  specialNeeds         String?
  status               String                @default("Active")
  photo                String?
  documents            String?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  attendances          Attendance[]
  BehaviorRecord       BehaviorRecord[]
  examResults          ExamResult[]
  hostelAllocations    HostelAllocation[]
  lessonProgress       LessonProgress[]
  libraryBorrowals     LibraryBorrowal[]
  guardian             Parent                @relation(fields: [guardianId], references: [id])
  academicYear         AcademicYear          @relation(fields: [academicYearId], references: [id])
  section              Section               @relation(fields: [sectionId], references: [id])
  grade                Grade                 @relation(fields: [gradeId], references: [id])
  user                 User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  transportAllocations TransportAllocation[]

  @@index([rollNumber])
  @@index([gradeId])
  @@index([academicYearId])
}

model Grade {
  id           String       @id @default(cuid())
  name         String
  numericValue Int
  order        Int
  description  String?
  sectionId    String?
  curriculums  Curriculum[]
  examPapers   ExamPaper[]
  lessons      Lesson[]
  sections     Section[]
  students     Student[]

  @@unique([name, sectionId])
}

model Section {
  id              String      @id @default(cuid())
  name            String
  gradeId         String
  roomNumber      String?
  capacity        Int         @default(40)
  currentStrength Int         @default(0)
  examPapers      ExamPaper[]
  lessons         Lesson[]
  grade           Grade       @relation(fields: [gradeId], references: [id])
  students        Student[]
  timetables      Timetable[]

  @@unique([name, gradeId])
}

model AcademicYear {
  id          String       @id @default(cuid())
  name        String
  startDate   DateTime
  endDate     DateTime
  isCurrent   Boolean      @default(false)
  curriculums Curriculum[]
  exams       Exam[]
  students    Student[]
  timetables  Timetable[]

  @@index([isCurrent])
}

model Attendance {
  id           String    @id @default(cuid())
  studentId    String
  date         DateTime
  status       String
  checkInTime  DateTime?
  checkOutTime DateTime?
  remarks      String?
  markedBy     String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  marker       User      @relation("AttendanceMarker", fields: [markedBy], references: [id])
  student      Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, date])
  @@index([date])
  @@index([status])
}

model Timetable {
  id             String        @id @default(cuid())
  sectionId      String
  dayOfWeek      String
  period         Int
  subjectId      String
  teacherId      String
  roomNumber     String?
  academicYearId String?
  academicYear   AcademicYear? @relation(fields: [academicYearId], references: [id])
  teacher        Teacher       @relation(fields: [teacherId], references: [id])
  subject        Subject       @relation(fields: [subjectId], references: [id])
  section        Section       @relation(fields: [sectionId], references: [id])

  @@index([sectionId, dayOfWeek, period])
}

model Subject {
  id          String       @id @default(cuid())
  name        String
  code        String       @unique
  description String?
  color       String?
  curriculums Curriculum[]
  examPapers  ExamPaper[]
  lessons     Lesson[]
  timetables  Timetable[]
}

model Exam {
  id             String       @id @default(cuid())
  name           String
  type           String
  academicYearId String
  gradeId        String?
  startDate      DateTime
  endDate        DateTime
  description    String?
  status         String       @default("Upcoming")
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id])
  papers         ExamPaper[]

  @@index([academicYearId])
}

model ExamPaper {
  id           String       @id @default(cuid())
  examId       String
  subjectId    String
  gradeId      String?
  sectionId    String?
  totalMarks   Int
  passingMarks Int
  duration     Int
  examDate     DateTime
  startTime    DateTime?
  endTime      DateTime?
  section      Section?     @relation(fields: [sectionId], references: [id])
  grade        Grade?       @relation(fields: [gradeId], references: [id])
  subject      Subject      @relation(fields: [subjectId], references: [id])
  exam         Exam         @relation(fields: [examId], references: [id])
  results      ExamResult[]
}

model ExamResult {
  id            String    @id @default(cuid())
  studentId     String
  examPaperId   String
  marksObtained Float
  percentage    Float
  grade         String?
  remarks       String?
  rank          Int?
  examPaper     ExamPaper @relation(fields: [examPaperId], references: [id])
  student       Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, examPaperId])
  @@index([studentId])
  @@index([examPaperId])
}

model Teacher {
  id             String      @id @default(cuid())
  userId         String      @unique
  employeeId     String      @unique
  firstName      String
  lastName       String
  gender         String
  dateOfBirth    DateTime
  bloodGroup     String?
  phone          String
  email          String
  address        String
  designation    String
  department     String?
  qualification  String?
  specialization String?
  experience     Float?
  joinDate       DateTime
  salary         Float?
  status         String      @default("Active")
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  courses        Course[]
  lessons        Lesson[]
  user           User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  timetables     Timetable[]

  @@index([employeeId])
}

model Staff {
  id            String   @id @default(cuid())
  userId        String   @unique
  employeeId    String   @unique
  firstName     String
  lastName      String
  gender        String
  dateOfBirth   DateTime
  phone         String
  email         String
  address       String
  department    String
  designation   String
  qualification String?
  joinDate      DateTime
  salary        Float?
  status        String   @default("Active")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Asset {
  id            String                 @id @default(cuid())
  assetCode     String                 @unique
  name          String
  category      String
  description   String?
  serialNumber  String?
  purchaseDate  DateTime?
  purchasePrice Float?
  currentValue  Float?
  condition     String
  location      String?
  assignedTo    String?
  status        String                 @default("Available")
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt
  transactions  InventoryTransaction[]

  @@index([category])
  @@index([status])
}

model InventoryTransaction {
  id           String   @id @default(cuid())
  assetId      String
  type         String
  fromLocation String?
  toLocation   String?
  assignedTo   String?
  quantity     Int      @default(1)
  remarks      String?
  performedBy  String
  createdAt    DateTime @default(now())
  performer    User     @relation("InventoryTransactionPerformer", fields: [performedBy], references: [id])
  asset        Asset    @relation(fields: [assetId], references: [id])
}

model Book {
  id              String            @id @default(cuid())
  isbn            String            @unique
  title           String
  author          String
  publisher       String?
  publicationYear Int?
  category        String
  language        String?
  pageCount       Int?
  totalCopies     Int
  availableCopies Int
  location        String?
  description     String?
  borrowals       LibraryBorrowal[]

  @@index([category])
  @@index([isbn])
}

model LibraryBorrowal {
  id         String    @id @default(cuid())
  bookId     String
  studentId  String
  borrowDate DateTime  @default(now())
  dueDate    DateTime
  returnDate DateTime?
  status     String    @default("Borrowed")
  fine       Float     @default(0)
  remarks    String?
  student    Student   @relation(fields: [studentId], references: [id])
  book       Book      @relation(fields: [bookId], references: [id])

  @@index([studentId])
  @@index([status])
}

model Vehicle {
  id              String                @id @default(cuid())
  vehicleNumber   String                @unique
  type            String
  capacity        Int
  driverName      String
  driverPhone     String
  routeNumber     String?
  model           String?
  licensePlate    String?
  insuranceExpiry DateTime?
  status          String                @default("Active")
  allocations     TransportAllocation[]

  @@index([routeNumber])
}

model TransportAllocation {
  id             String  @id @default(cuid())
  vehicleId      String
  studentId      String
  pickupPoint    String?
  pickupTime     String?
  dropPoint      String?
  dropTime       String?
  academicYearId String
  fees           Float?
  student        Student @relation(fields: [studentId], references: [id])
  vehicle        Vehicle @relation(fields: [vehicleId], references: [id])

  @@unique([studentId, academicYearId])
  @@index([vehicleId])
}

model Hostel {
  id               String             @id @default(cuid())
  name             String
  type             String
  capacity         Int
  currentOccupancy Int                @default(0)
  wardenName       String?
  wardenPhone      String?
  address          String?
  allocations      HostelAllocation[]
  rooms            Room[]
}

model Room {
  id               String             @id @default(cuid())
  hostelId         String
  roomNumber       String
  floor            Int
  capacity         Int
  currentOccupancy Int                @default(0)
  type             String?
  facilities       String?
  allocations      HostelAllocation[]
  hostel           Hostel             @relation(fields: [hostelId], references: [id])

  @@unique([hostelId, roomNumber])
}

model HostelAllocation {
  id             String    @id @default(cuid())
  hostelId       String
  roomId         String
  studentId      String
  academicYearId String
  allocationDate DateTime  @default(now())
  checkoutDate   DateTime?
  fees           Float?
  status         String    @default("Active")
  student        Student   @relation(fields: [studentId], references: [id])
  room           Room      @relation(fields: [roomId], references: [id])
  hostel         Hostel    @relation(fields: [hostelId], references: [id])

  @@unique([studentId, academicYearId])
  @@index([roomId])
}

model Parent {
  id         String    @id @default(cuid())
  userId     String    @unique
  firstName  String
  lastName   String
  phone      String
  email      String?
  address    String?
  occupation String?
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  children   Student[]

  @@index([phone])
}

model Message {
  id         String    @id @default(cuid())
  senderId   String
  receiverId String
  subject    String?
  content    String
  type       String
  priority   String    @default("Normal")
  isRead     Boolean   @default(false)
  readAt     DateTime?
  createdAt  DateTime  @default(now())
  receiver   User      @relation("MessageReceiver", fields: [receiverId], references: [id])
  sender     User      @relation("MessageSender", fields: [senderId], references: [id])

  @@index([senderId])
  @@index([receiverId])
  @@index([isRead])
}

model Curriculum {
  id             String       @id @default(cuid())
  name           String
  subjectId      String
  gradeId        String
  academicYearId String
  description    String?
  objectives     String?
  topics         String?
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id])
  grade          Grade        @relation(fields: [gradeId], references: [id])
  subject        Subject      @relation(fields: [subjectId], references: [id])
  lessons        Lesson[]

  @@unique([name, subjectId, gradeId, academicYearId])
  @@index([subjectId, gradeId])
}

model Lesson {
  id           String      @id @default(cuid())
  curriculumId String?
  subjectId    String
  gradeId      String?
  sectionId    String?
  teacherId    String
  title        String
  content      String?
  resources    String?
  date         DateTime
  duration     Int?
  status       String      @default("Planned")
  section      Section?    @relation(fields: [sectionId], references: [id])
  grade        Grade?      @relation(fields: [gradeId], references: [id])
  curriculum   Curriculum? @relation(fields: [curriculumId], references: [id])
  teacher      Teacher     @relation(fields: [teacherId], references: [id])
  subject      Subject     @relation(fields: [subjectId], references: [id])

  @@index([teacherId])
  @@index([date])
}

model Course {
  id             String         @id @default(cuid())
  title          String
  code           String         @unique
  subjectId      String
  gradeId        String?
  teacherId      String?
  description    String?
  coverImage     String?
  isPublished    Boolean        @default(false)
  enrollmentOpen Boolean        @default(true)
  teacher        Teacher?       @relation(fields: [teacherId], references: [id])
  modules        CourseModule[] @relation("CourseModules")

  @@index([subjectId])
}

model CourseModule {
  id          String         @id @default(cuid())
  courseId    String
  title       String
  description String?
  order       Int
  isPublished Boolean        @default(false)
  lessons     CourseLesson[]
  course      Course         @relation("CourseModules", fields: [courseId], references: [id])

  @@index([courseId])
}

model CourseLesson {
  id          String           @id @default(cuid())
  moduleID    String
  title       String
  content     String?
  videoUrl    String?
  attachments String?
  order       Int
  isPublished Boolean          @default(false)
  module      CourseModule     @relation(fields: [moduleID], references: [id])
  progress    LessonProgress[]
}

model LessonProgress {
  id          String       @id @default(cuid())
  lessonId    String
  studentId   String
  completed   Boolean      @default(false)
  completedAt DateTime?
  student     Student      @relation(fields: [studentId], references: [id])
  lesson      CourseLesson @relation(fields: [lessonId], references: [id])

  @@unique([lessonId, studentId])
}

model SystemSettings {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  category    String?
  description String?
  updatedAt   DateTime @updatedAt

  @@index([category])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  entity    String
  entityId  String?
  details   String?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String?
  title     String
  message   String
  type      String
  link      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
}

model Report {
  id          String   @id @default(cuid())
  name        String
  type        String
  parameters  String?
  generatedBy String
  fileUrl     String?
  createdAt   DateTime @default(now())

  @@index([type])
  @@index([createdAt])
}

model BehaviorRecord {
  id             String   @id
  studentId      String
  date           DateTime @default(now())
  type           String
  category       String
  description    String
  points         Int
  reportedBy     String
  actionTaken    String?
  parentNotified Boolean  @default(false)
  User           User     @relation(fields: [reportedBy], references: [id])
  Student        Student  @relation(fields: [studentId], references: [id])

  @@index([type])
  @@index([date])
  @@index([studentId])
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  TEACHER
  STUDENT
  PARENT
  STAFF
  LIBRARIAN
}
